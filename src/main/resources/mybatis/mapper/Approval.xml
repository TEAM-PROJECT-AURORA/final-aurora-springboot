<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.root34.aurora.approval.dao.ApprovalMapper">

    <resultMap id="approvalResultMap" type="com.root34.aurora.approval.dto.ApprovalDTO">
        <id property="appCode" column="APP_CODE"/>
        <result property="appTitle" column="APP_TITLE"/>
        <result property="appDescript" column="APP_DESCRIPT"/>
        <result property="appDate" column="APP_DATE"/>
        <result property="appEndDate" column="APP_END_DATE"/>
        <result property="appOpen" column="APP_OPEN"/>
        <association property="documentDTO" resultMap="documentResultMap">
            <id property="docCode" column="DOC_CODE"/>
            <result property="docName" column="DOC_NAME"/>
        </association>
        <association property="memberDTO" resultMap="memberResultMap">
            <id property="memberCode" column="MEMBER_CODE"/>
        </association>
    </resultMap>

    <resultMap id="documentResultMap" type="com.root34.aurora.approval.dto.DocumentDTO">
        <id property="docCode" column="DOC_CODE"/>
        <result property="docName" column="DOC_NAME"/>
    </resultMap>

    <resultMap id="memberResultMap" type="com.root34.aurora.member.dto.MemberDTO">
        <id property="memberCode" column="MEMBER_CODE"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberPassword" column="MEMBER_PASSWORD"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberEmail" column="MEMBER_EMAIL"/>
        <result property="memberRole" column="MEMBER_ROLE"/>
    </resultMap>

    <insert id="insertApprove" parameterType="ApprovalDTO">
        INSERT INTO TBL_APPROVAL
        (APP_CODE, DOC_CODE, MEMBER_CODE, APP_TITLE, APP_DESCRIPT, APP_DATE, APP_END_DATE, APP_OPEN)
        VALUES
            (null, #{ documentDto.docCode }, #{ memberDto.memberCode }, #{ appTitle }, #{ appDescript }, #{ appDate }, #{ appEndDate },
             #{ appOpen } )
    </insert>

    <select id="lastList" resultMap="approvalResultMap">
        SELECT
            tm.MEMBER_NAME ,
            td.DOC_NAME ,
            ta.APP_TITLE ,
            ta.APP_DATE ,
            ta.APP_END_DATE
        from TBL_APPROVAL ta
                 JOIN TBL_DOCUMENT td ON ta.DOC_CODE = td.DOC_CODE
                 JOIN TBL_MEMBER tm ON ta.MEMBER_CODE = tm.MEMBER_CODE
        where ta.APP_DATE >= date_sub(now(), INTERVAL 7 DAY)
    </select>

    <select id="pendingList" resultType="ApprovalDTO">
        select
            ta.APP_TITLE ,
            tal.APP_STATUS
        from TBL_APPROVAL ta
                 join TBL_APPROVAL_LINE tal
                      ON   (ta.APP_CODE = tal.APP_CODE)
        where tal.APP_STATUS = 'N'
    </select>

    <select id="detailApprove" resultType="ApprovalDTO">
        select
            *
        from TBL_APPROVAL ta
        where ta.APP_CODE = #{ appCode }
    </select>

    <select id="completedList" resultType="ApprovalDTO">
        elect
        *
        from TBL_APPROVAL ta
                 join TBL_APPROVAL_LINE tal
                      ON   (ta.APP_CODE = tal.APP_CODE)
        where tal.APP_STATUS = 'Y'
    </select>

    <update id="updateApporval" parameterType="ApprovalDTO">
        update TBL_APPROVAL
        set
            APP_TITLE = #{ appTItle },
            APP_DATE = #{ appDate }
        where APP_CODE = #{ appCode }
    </update>

    <delete id="deleteApproval" parameterType="ApprovalDTO">
        delete from TBL_APPROVAL
        where APP_CODE = #{ appCode }
    </delete>
</mapper>