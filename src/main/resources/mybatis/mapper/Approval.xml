<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.root34.aurora.approval.dao.ApprovalMapper">

    <resultMap id="approvalResultMap" type="com.root34.aurora.approval.dto.ApprovalDTO">
        <id property="appCode" column="APP_CODE"/>
        <result property="appTitle" column="APP_TITLE"/>
        <result property="appDescript" column="APP_DESCRIPT"/>
        <result property="appDate" column="APP_DATE"/>
        <result property="appEndDate" column="APP_END_DATE"/>
        <result property="appOpen" column="APP_OPEN"/>
        <association property="documentDTO" resultMap="documentResultMap">
            <id property="docCode" column="DOC_CODE"/>
            <result property="docName" column="DOC_NAME"/>
        </association>
        <association property="memberDTO" resultMap="memberResultMap">
            <id property="memberCode" column="MEMBER_CODE"/>
        </association>
    </resultMap>

    <resultMap id="approvalLineResultMap" type="com.root34.aurora.approval.dto.ApprovalLineDTO">
        <id property="appLineCode" column="APP_LINE_CODE"/>
        <result property="appStatus" column="APP_STATUS"/>
        <association property="approvalDTO" resultMap="approvalResultMap">
            <id property="appCode" column="APP_CODE"/>
        </association>
        <association property="memberDTO" resultMap="memberResultMap">
            <id property="memberCode" column="MEMBER_CODE"/>
        </association>
    </resultMap>

    <resultMap id="documentResultMap" type="com.root34.aurora.approval.dto.DocumentDTO">
        <id property="docCode" column="DOC_CODE"/>
        <result property="docName" column="DOC_NAME"/>
    </resultMap>

    <resultMap id="memberResultMap" type="com.root34.aurora.member.dto.MemberDTO">
        <id property="memberCode" column="MEMBER_CODE"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberPassword" column="MEMBER_PASSWORD"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberEmail" column="MEMBER_EMAIL"/>
        <result property="memberRole" column="MEMBER_ROLE"/>
    </resultMap>

    <insert id="insertApprove" parameterType="com.root34.aurora.approval.dto.ApprovalDTO">
        INSERT INTO TBL_APPROVAL
        (DOC_CODE, MEMBER_CODE, APP_TITLE, APP_DESCRIPT, APP_END_DATE, APP_OPEN)
        VALUES
            (#{ documentDTO.docCode }, #{ memberDTO.memberCode }, #{ appTitle }, #{ appDescript }, #{ appEndDate },
             #{ appOpen } )
    </insert>

    <insert id="setLineApproval" parameterType="list">
        INSERT INTO TBL_APPROVAL_LINE
        (APP_CODE, MEMBER_CODE, APP_STATUS)
        VALUES
            <foreach collection="list" item="approvalLine" separator=",">
                (#{ approvalLine.appCode }, #{ approvalLine.memberDTO.memberCode }, #{ approvalLine.appStatus })
            </foreach>
    </insert>

    <select id="lastList" resultMap="approvalResultMap">
        SELECT
            *
        from TBL_APPROVAL ta
                 JOIN TBL_DOCUMENT td ON ta.DOC_CODE = td.DOC_CODE
                 JOIN TBL_MEMBER tm ON ta.MEMBER_CODE = tm.MEMBER_CODE
        where ta.APP_DATE >= date_sub(now(), INTERVAL 7 DAY) and ta.MEMBER_CODE = #{ memberCode }
    </select>

    <select id="pendingList" resultType="ApprovalDTO">
        select
            ta.APP_TITLE ,
            tal.APP_STATUS
        from TBL_APPROVAL ta
                 join TBL_APPROVAL_LINE tal
                      ON   (ta.APP_CODE = tal.APP_CODE)
        where tal.APP_STATUS = 'N' and ta.MEMBER_CODE = #{ memberCode }
    </select>

    <select id="detailApprove" resultType="ApprovalDTO">
        select
            *
        from TBL_APPROVAL ta
        where ta.APP_CODE = #{ appCode }
    </select>

    <select id="completedList" resultType="ApprovalDTO">
        elect
        *
        from TBL_APPROVAL ta
                 join TBL_APPROVAL_LINE tal
                      ON   (ta.APP_CODE = tal.APP_CODE)
        where tal.APP_STATUS = 'Y' and ta.MEMBER_CODE = #{ memberCode }
    </select>

    <update id="updateApporval" parameterType="ApprovalDTO">
        update TBL_APPROVAL
        set
            APP_TITLE = #{ appTItle },
            APP_DATE = #{ appDate }
        where APP_CODE = #{ appCode }
    </update>
<!-- 삭제시 결제선까지 같이 제거 -->
    <delete id="deleteApproval" parameterType="map">
        delete from TBL_APPROVAL where APP_CODE = #{ appCode };
        delete from TBL_APPROVAL_LINE where APP_CODE = #{ appCode }
    </delete>
</mapper>